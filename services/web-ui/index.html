<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Data Warehouse Simulator</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <div class="page-shell">
      <header>
        <h1>Data Warehouse Simulator</h1>
        <p>Manage experiment schemas locally via the Python API.</p>
      </header>

      <main>
        <!-- Tab Navigation -->
        <div class="main-tabs">
          <button type="button" class="main-tab active" data-tab="experiments">Experiments</button>
          <button type="button" class="main-tab" data-tab="create">Create Experiment</button>
          <button type="button" class="main-tab" data-tab="query">Query Data</button>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
          <!-- Experiments Tab -->
          <section id="tab-experiments" class="tab-panel active">
            <div class="panel">
              <div class="panel-header">
                <h2>Experiments</h2>
                <button id="refresh-btn" type="button">Refresh</button>
              </div>
              <div
                id="warning-banner"
                class="warning-banner hidden"
                role="alert"
                aria-live="polite"
              ></div>
              <div id="status" class="status-message" role="status" aria-live="polite"></div>
              <ul id="experiment-list" class="experiment-list"></ul>
            </div>
          </section>

          <!-- Create Experiment Tab -->
          <section id="tab-create" class="tab-panel">
            <div class="panel">
              <h2>Create Experiment</h2>
              <div
                id="create-warning-banner"
                class="warning-banner hidden"
                role="alert"
                aria-live="polite"
              ></div>
              <div class="mode-tabs">
                <button type="button" class="mode-tab active" data-mode="json">JSON Schema</button>
                <button type="button" class="mode-tab" data-mode="sql">SQL Import</button>
              </div>

              <form id="json-form">
                <label for="json-warehouse-select">Target Warehouse</label>
                <select id="json-warehouse-select">
                  <option value="">Default</option>
                  <option value="redshift">Redshift (PostgreSQL emulator)</option>
                  <option value="snowflake">Snowflake (LocalStack emulator)</option>
                  <option value="sqlite">SQLite</option>
                </select>
                <label for="schema-input">Experiment JSON schema</label>
                <textarea id="schema-input" rows="12" required></textarea>
                <div class="actions">
                  <button type="submit">Create Experiment</button>
                </div>

              <details>
                <summary>Sample JSON schema</summary>
              <pre>{
  "name": "customers_experiment",
  "tables": [
    {
      "name": "customers",
      "target_rows": 1000,
      "columns": [
        {"name": "customer_id", "data_type": "INT", "is_unique": true},
        {"name": "email", "data_type": "VARCHAR", "varchar_length": 255},
        {
          "name": "lifetime_value",
          "data_type": "FLOAT",
          "distribution": {
            "type": "normal",
            "parameters": {"mean": 500, "stddev": 120}
          }
        }
      ]
    }
  ]
}</pre>
              </details>
              </form>

              <form id="sql-form" class="hidden">
                <label for="sql-experiment-name">Experiment name</label>
                <input id="sql-experiment-name" type="text" placeholder="rl_dw" required />

                <div class="form-row">
                  <div class="form-field">
                    <label for="dialect-select">SQL Dialect</label>
                    <select id="dialect-select">
                      <option value="redshift">Amazon Redshift</option>
                      <option value="snowflake">Snowflake</option>
                      <option value="ansi">ANSI</option>
                    </select>
                  </div>
                  <div class="form-field">
                    <label for="warehouse-select">Target Warehouse</label>
                    <select id="warehouse-select">
                      <option value="">Default</option>
                      <option value="redshift">Redshift (PostgreSQL emulator)</option>
                      <option value="snowflake">Snowflake (LocalStack emulator)</option>
                      <option value="sqlite">SQLite</option>
                    </select>
                  </div>
                </div>

                <label for="sql-input">SQL (CREATE TABLE ...)</label>
                <textarea id="sql-input" rows="12" required></textarea>
                <div class="actions">
                  <button type="submit">Import SQL</button>
                </div>
              </form>

            </div>
          </section>

          <!-- SQL Query Tab -->
          <section id="tab-query" class="tab-panel">
            <div class="panel">
              <h2>SQL Query Interface</h2>
              <p class="query-description">Execute SQL queries against your populated experiments and export results.</p>

              <form id="query-form">
                <label for="experiment-select">Experiment</label>
                <select id="experiment-select" required>
                  <option value="" disabled selected>Select an experiment...</option>
                </select>
                <small class="query-hint">Select an experiment to query. You can use simple table names (e.g., "customers" instead of "customers_experiment__customers")</small>

                <div id="dialect-info" class="dialect-info hidden">
                  <strong>Warehouse:</strong> <span id="selected-warehouse">-</span> Â·
                  <strong>SQL Dialect:</strong> <span id="selected-dialect">-</span>
                </div>

                <div id="table-helper" class="table-helper hidden" aria-live="polite">
                  <div class="table-helper-header">
                    <div>
                      <strong>Available Tables</strong>
                      <span id="table-helper-count"></span>
                    </div>
                    <span class="table-helper-hint">Click a table to insert it into the query.</span>
                    <button
                      id="table-schema-toggle"
                      type="button"
                      class="table-schema-toggle"
                      aria-pressed="false"
                    >
                      View schema
                    </button>
                  </div>
                  <p id="table-helper-empty" class="table-helper-empty">Select an experiment to see available tables.</p>
                  <ul id="table-helper-list" class="table-helper-list"></ul>
                  <div id="table-schema-details" class="table-schema-details hidden"></div>
                </div>

                <label for="query-input">SQL Query</label>
                <div class="query-input-wrapper">
                  <textarea
                    id="query-input"
                    rows="8"
                    placeholder="SELECT * FROM customers LIMIT 10;"
                    required
                  ></textarea>
                  <div
                    id="table-suggestions"
                    class="table-suggestions hidden"
                    role="listbox"
                    aria-label="Table name suggestions"
                  ></div>
                </div>
                <small class="query-helper-note">Press Ctrl + Space or start typing a table name to auto-complete.</small>

                <div class="query-actions">
                  <button type="submit" class="primary">Execute Query</button>
                  <button type="button" id="clear-query-btn" class="secondary">Clear</button>
                  <button type="button" id="save-query-btn" class="secondary">Save SQL</button>
                </div>
              </form>

              <div id="query-status" class="query-status" role="status" aria-live="polite"></div>

              <div id="query-results-container" class="hidden">
                <div class="results-header">
                  <h3>Query Results</h3>
                  <div class="results-actions">
                    <span id="row-count-display"></span>
                    <button type="button" id="export-csv-btn" class="secondary">Export CSV</button>
                  </div>
                </div>
                <div id="query-results" class="query-results"></div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <!-- Generate Data Modal -->
    <div id="generate-modal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Generate Synthetic Data</h2>
          <button class="modal-close" type="button">&times;</button>
        </div>
        <form id="generate-form">
          <p>Experiment: <strong id="generate-experiment-name"></strong></p>

          <div id="table-overrides"></div>

          <label for="seed-input">Seed (optional, for deterministic generation)</label>
          <input id="seed-input" type="number" placeholder="e.g., 123" />

          <div class="actions">
            <button type="submit" class="primary">Generate Data</button>
            <button type="button" class="cancel-btn">Cancel</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Generation Runs Modal -->
    <div id="runs-modal" class="modal hidden">
      <div class="modal-content runs-modal-content">
        <div class="modal-header">
          <h2>Generation Runs: <span id="runs-experiment-name"></span></h2>
          <button class="modal-close runs-modal-close" type="button">&times;</button>
        </div>
        <div id="runs-list-container">
          <p class="runs-loading">Loading runs...</p>
        </div>
      </div>
    </div>

    <script type="module" src="main.js"></script>
  </body>
</html>
