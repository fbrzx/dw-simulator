# Example Queries

This directory contains example SQL queries for analyzing the generated datasets. Queries are organized by SQL dialect to ensure compatibility with different data warehouse platforms.

## Directory Structure

```
queries/
├── postgresql/     # PostgreSQL and Redshift compatible queries
├── sqlite/         # SQLite compatible queries
└── README.md       # This file
```

## Dialect Differences

The queries differ between dialects in the following ways:

### Date Formatting

| Dialect | Function | Example |
|---------|----------|---------|
| **SQLite** | `strftime()` | `strftime('%Y-%m', order_date)` |
| **PostgreSQL/Redshift** | `to_char()` | `to_char(order_date, 'YYYY-MM')` |

**Affected Queries:**
- `ecommerce_03_monthly_revenue.sql`
- `ecommerce_04_customer_cohorts.sql`

### String Aggregation

| Dialect | Function | Example |
|---------|----------|---------|
| **SQLite** | `GROUP_CONCAT()` | `GROUP_CONCAT(product_name, ', ')` |
| **PostgreSQL/Redshift** | `STRING_AGG()` | `STRING_AGG(product_name, ', ')` |

**Affected Queries:**
- `ecommerce_05_cart_analysis.sql`

### Boolean Comparisons

| Dialect | Syntax | Example |
|---------|--------|---------|
| **SQLite** | Integer comparison | `WHERE delivered = 1` |
| **PostgreSQL/Redshift** | Boolean comparison | `WHERE delivered = true` or `WHERE delivered` |

**Affected Queries:**
- `marketing_01_campaign_performance.sql`
- `marketing_02_subscriber_engagement.sql`
- `marketing_03_funnel_analysis.sql`
- `marketing_05_time_series.sql`

## Query Descriptions

### E-commerce Queries (ecommerce_simple dataset)

1. **ecommerce_01_customer_metrics.sql** - Customer lifetime value and purchase behavior
2. **ecommerce_02_product_performance.sql** - Product sales, revenue, and profitability analysis
3. **ecommerce_03_monthly_revenue.sql** - Monthly revenue trends and order patterns
4. **ecommerce_04_customer_cohorts.sql** - Customer cohort analysis by signup month
5. **ecommerce_05_cart_analysis.sql** - Shopping cart composition and product combinations

### Marketing Queries (marketing_campaigns dataset)

1. **marketing_01_campaign_performance.sql** - Campaign-level metrics: sends, opens, clicks, and conversion rates
2. **marketing_02_subscriber_engagement.sql** - Individual subscriber behavior and engagement levels
3. **marketing_03_funnel_analysis.sql** - Email marketing funnel conversion analysis
4. **marketing_04_device_analysis.sql** - Device type and user agent engagement patterns
5. **marketing_05_time_series.sql** - Daily email performance time series

## Usage

### PostgreSQL/Redshift

The data generated by the simulator is loaded into PostgreSQL (or Redshift mock) by default. Use the queries in the `postgresql/` directory:

```bash
# Run a query against the database
docker exec dw-simulator-local-redshift-mock-1 psql -U dw_user -d dw_simulator \
  -f /path/to/postgresql/ecommerce_01_customer_metrics.sql
```

### SQLite

If you're working with SQLite exports or local analysis, use the queries in the `sqlite/` directory:

```bash
# Run a query against SQLite database
sqlite3 data.db < sqlite/ecommerce_01_customer_metrics.sql
```

## Testing Queries

All queries in the `postgresql/` directory have been tested against the generated datasets and verified to work correctly.

To test a query manually:

```bash
# Test PostgreSQL query
docker exec dw-simulator-local-redshift-mock-1 psql -U dw_user -d dw_simulator \
  -c "$(cat docs/examples/queries/postgresql/ecommerce_01_customer_metrics.sql)"
```

## Adding New Queries

When adding new queries:

1. Create both PostgreSQL and SQLite versions if using dialect-specific features
2. Place them in the appropriate dialect directory
3. Document any dialect differences in this README
4. Test the query against generated data before committing

## See Also

- [Schema Examples](../schemas/) - Dataset schema definitions
- [Main Documentation](../../README.md) - Project overview and setup
